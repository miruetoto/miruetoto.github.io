---
layout: post 
title: (리뷰) LOF
---

### About this document 
- 여기서는 아래의 논문을 요약하였다. <br/>
***REF***: Breunig, M. M., Kriegel, H. P., Ng, R. T., & Sander, J. (2000, May). LOF: identifying density-based local outliers. In ACM sigmod record (Vol. 29, No. 2, pp. 93-104). ACM.

- 위의 논문에서는 **리처빌리티-디스턴스(Reachability Distance)** 라는 개념이 나오는데 이것이 HST에서 제안하는 dissimilarity와 유사하다. 이 논문에서 제시한 anormally detection방법과 우리의 방법을 비교해보면 매우 유익할것이다. 

- 가급적 논문에 나오는 노테이션을 따라갈것이다. (내가 이러한 노테이션을 좋아하는건 아니다. 노테이션이 진짜 거지같다.) 

### 4. Formal definition of local outliers 
- **(Definition 3)** 여기에서는 $k-distance(p)$라는 것을 정의한다. $k-distance(p)$의 의미는 **"점 $p$"와 "$p$로부터 $k$번째로 가까운 점"과의 거리**를 의미한다. $p$와 가장 가까운 점은 자기자신이므로 $k=1$이면 $k-distance(p)=0$이다. 즉 모든 경우에 클리어하게 아래가 정의된다. 
\begin{align}
1-distance(p)=d(p-p)=0
\end{align}
그런데 만약에 점 $p$로부터 $k$번째로 가까운 점이 2개면 정의가 애매해진다. 이때는 그냥 동점자끼리는 같은 거리를 가진다고 생각하고 정의해버린다. 예를 들어보자. 하나의 수직선위에 점 $\\{-1,0,1,2,3,4\\}$가 있다고 하자. 편의상 $p=0$이라고 하자. 일단 언급한바와 같이 아래가 성립한다. 
\begin{align}
1-distance(0)=0
\end{align}
이다. $k=2$인 경우를 살펴보자. 점 $\\{0\\}$과 두번째로 가까운 점은 $\\{-1,1\\}$ 이런경우는 아래와 같이 정의한다. 
\begin{align}
2-distance(0)=3-distance(0)=1
\end{align}
**앞으로는 논의를 빠르게 하고 논문의 이해를 돕기위해서 위와같은 상황은 없다고 가정하자.**

- **(Definition 4)** 여기에서는 **"점 $p$의 $k-distance$ 이웃들"**($k-distance$ neighborhood of $p$)이라는 개념이 나온다. 요거는 기호로 $N_{k-distance(p)}(p)$라고 표현하고 아래와 같이 정의한다.
\begin{align}
N_{k-distance(p)}(p)=\\{q \in D- \\{p\\} | d(p,q) \leq k-distance(p) \\} 
\end{align}
여기에서 $D$는 전체 데이터셋을 의미한다. 쉽게 말하면 **$p$의 $k-distance$ 이웃들** 점 $p$와 가까운 점 $k-1$개를 의미한다. (자기자신을 빼므로 $k$개가 아니라 $k-1$개임).

- **(Definition 5)** 여기에서는 $p$에서 $o$까지의 **리처빌리티-디스턴스(Reachability Distance)** 를 정의한다. **리처빌리티-디스턴스** 는 기호로 $reach-dist_{k}(p,o)$라고 쓰고 아래와 같이 정의한다. 
\begin{align}
reach-dist_{k}(p,o)= \max (k-distance(o) ,d(p-o)) 
\end{align}

- 이해를 돕기 위해서 $D=\\{-2,-1,0,1,2,3,\dots\\}$라 가정하고 예제를 통하여 몇 가지를 구해보자. 
\begin{align}
reach-dist_{1}(0,-2)=\max (0,2) = 2 
\end{align}
\begin{align}
reach-dist_{2}(0,-2)=\max (1,2) = 2 
\end{align}
\begin{align}
reach-dist_{3}(0,-2)=\max (2,2) = 2 
\end{align}
\begin{align}
...
\end{align}
\begin{align}
reach-dist_{6}(0,-2)=\max (3,2) = 3 
\end{align}

- 여기에서 $k$는 어떠한 역할을 할까? 극단적으로 생각해서 $k$가 엄청 크다고 하자. 예를 들어서 $k=\|D\|$라고 하자. 그러면 $reach-dist_{k}(p,o)$의 값은 점 $o$와 가장 멀리 떨어진 점과의 거리로 고정된다. $k$가 엄청작으면 $reach-dist_{k}(p,o)$ 의 값은 그냥 $p$와 $o$와의 유클리드 거리가 된다. 매우 특이한점은 "점 $o$ 주위에 얼만큼 다른점들이 밀집되어 있느냐에 따라서 $k-distance(o)$ 의 값이 달라지고 이것은 결국 $reach-dist_{k}(p,o)$ 가 달라지게 되는 결과를 만든다" 는 것이다. 

- 좀 더 구체적으로 따져보자. $k$를 적당한 자연수로 고정시키자. 점 $o$ 주변에 많은 점들이 밀집되어있다고 하자. 그럼 $k-distance(o)$의 값은 작아질 것이고 $reach-dist_{k}(p,o)$는 단순히 점 $p$와 $o$의 유클리드 거리가 될 것이다. 이제 점 $o$ 주변에 점들이 듬성듬성 잇다고 치자. 그럼 $k-distance(o)$의 값은 커질것이고 따라서 $reach-dist_{k}(p,o)$값도 커질 것이다. 

- 결론적으로 말해서 $reach-dist_{k}(p,o)$는 **(1) 기본적으로 점 $k$와 점 $o$의 거리를 나타내는데 (2) 점 $o$의 주변의 밀도가 낮을수록 $o$를 $k$로부터 더 멀리있는 점으로 인식하게끔 만든 거리** 라고 볼 수 있다. 

- 저자들은 이 $k$를 Minpts라고 표현한다. 정확한 의미는 모르겠지만 **minimal number of points**의 약자인것 같다. 여기에서는 그냥 계속 $k$라고 표현하겠다. 

- 잘 살펴보면 **리처블러티-디스턴스** 는 특정 점 $o$ 주변의 **조밀함** 을 반영한 거리라고 볼 수 있다. 무슨말인지 예를들어 설명해보도록 하자. 점 $p$와 유클리드 거리상으로 똑같은 거리에 있는 두점 $o_1$과 $o_2$가 있다고 생각하자. 그런데 점 $o_1$ 주변에는 다른점들이 엄청 조밀하게 있고 점 $o_2$ 주변에는 다른점들이 듬성듬성 있다고 하자. 이런 경우 점 $o_2$가 점 $o_1$보다 $p$ 로부터 **더 멀리 떨어져있다** 고 생각하자는 것이다. 그리고 바로 요런거리를 정의함에 따라서 점 $o$들의 local outlierness를 메져할 수 있는 트릭을 만들 수 있다. 

- **(Definition 6)** 이제 **로칼-리처빌리티-덴시티(Local Reachability Density)** 에 대하여 알아보자. 점 $p$의 **로칼-리처빌리티-덴시티**는 아래와 같이 정의한다. 
\begin{align}
lrd_{k}(p)=\left(\frac{1}{\|N_{k}(p)\|} \sum_{o \in N_{k}(p)} reach-dist_k(p,o)\right)^{-1}
\end{align}
이게 논문에서는 $k$대신에 Minpt를 사용하였다. 여기에서 $N_{k}(p)$는 (동점자가 없는 상황에서는) 점 $p$와 가장 가까운 점들 $k$개를 의미하므로 사실상 대부분의 경우에 $\|N_{k}(p)\|=k$라고 생각해도 무방하다. 아무튼 $p$와 가장 가까운 점 $k$개를 뽑아서 그 점들의 **리처블러티-디스턴스** 의 평균을 구한것이 
\begin{align}
\frac{1}{\|N_{k}(p)\|} \sum_{o \in N_{k}(p)} reach-dist_k(p,o)
\end{align}
이 된다. 즉 위의 값은 먼지는 몰라도 **평균거리** 정도의 느낌을 가진 메져이다. 

- 이게 이제 무슨 의미를 가지는지 살펴보자. 일단 
\begin{align}
\frac{1}{\|N_{k}(p)\|} \sum_{o \in N_{k}(p)} reach-dist_k(p,o)
\end{align}
는 거리이기 때문에 $p$근처에 점들이 평균적으로 많이 떨어져 있을수록 이 값은 크게 나타나진다. 즉 $p$가 홀로 존재하는것 처럼 보일때 이 값은 크다. 따라서 $p$가 다른점들과 멀리 멀리 떨어져 있을 수록 $p$의 **로칼-리처빌리티-덴시티**는 작다. (즉 $p$의 **조밀함**은 작다) 이제 유클리디안-평균거리가 아닌 리처빌러티-디스턴스의 평균거리를 고려해야 하는 이유를 따져보자. 점 $p$가 홀로 떨어진듯 보인다. 이제 점 $p$의 $k-distance$ 이웃들 즉 **(1)** $N_{k-distance(p)}$의 원소들이 모두 서로 붙어있는 경우와 **(2)** $N_{k-distance(p)}$의 원소들이 서로 떨어져 있는 경우를 각각 상상하여 보자. (2)의 경우가 $N_{k-distance(p)}$의 원소들의 평균적인 **리처빌리티-디스턴스**가 크게 나오므로 (2)의 경우 $p$의 **조밀함**이 더 작다고 볼 수 있다. 이는 $p$의 조밀함은 (1) $p$근처에 점들이 많을수록(=이웃들이 많을수록) **조밀**하다고 판단하며 (2) $p$근처의 $k$-distance 이웃들 간의 거리도 가까울수록 **조밀**하다고 판단하는 것이다. 

- 이해를 돕기위해서 좀 세속적인 비유를 해보자. 점 $p$가 얼마나 **인싸**인지를 클러스터의 중심점인지를 측정하기 위해서는 (1) 점 $p$ 근처에 얼마나 많은 이웃 혹은 친구들이 있는지 (2) 점$p$의 이웃 혹은 친구들은 서로가 얼마나 친한지를 모두 보아야 한다는 것이다. 계속 비유를 해보자. 두명의 사람 $p$와 $p'$이 있다고 하자. $p$와 $p'$이 친한 친구는 모두 똑같이 5명인데, 이 $p$와 친한 이 5명은 서로서로도(=끼리끼리도) 모두 친하다(즉 5명모두 인싸라고 생각가능). 그런데 $p'$가 친한 5명은 서로서로가 친하지 않다. 그러면 $p$가 더 인싸라고 생각한다는 것이다. 즉 본인이 잘나가는(=인싸인) 정도를 판단하려면 본인자체가 잘나가는(=친구가많은)것도 중요하지만 본인 주변의 친구들이 얼마나 잘나가는지도 살펴보아야 한다는 것이다. 

- **(Definition 7)** 이제 대망의 **LOF(local outlier factor)** 를 정의하여보자. LOF는 아래와 같이 정의한다. 
\begin{align}
LOF_{k}(p)=\frac{1}{\|N_{k}(p)\|} \sum_{o \in N_{k}(p)} \frac{lrd_k(o)}{lrd_k(p)}
\end{align}
이건 그냥 너무 클리어한 정의이다. $p$근처에는 점이 하나도 없고 $p$의 이웃들은 다 모여있는 경우가 $p$의 LOF가 가장 크게 나타난다. 

- 점 $p$가 클러스터 안에 폭 파묻혀 있다면 $p$의 LOF값은 1에 가까울 것이다. 즉 $LOF_{k}(p) \approx 1$ 이다. 

### Properties of local outliers 

- 논문의 Fig 1 에서 $o_2$는 아웃라이어로 판단하고 클러스터 $C_1$에 존재하는 다른 모든점들은 아웃라이어가 아니라고 판단하는 것이 우리의 목표이다. (즉 $o \in C_1$ 이면 $LOF_k(o) \approx 1$이 성립하게끔 하는것) 우리가 정의한 LOF가 과연 이러한 성질을 만족할까? Lemma1은 $C_1$에 존재하는 모든 점들은 아웃라이어가 아니라는 결론을 주는(정말?? 좀 애매한데? ㅋㅋ) 레마이다. 

- **(Lemma 1)** $C$를 임의의 클러스터라고 하자. $reach-dist-min$ 이라는 것을 정의할 것인데 이것은 $C$내에 있는 모든 자료의 **리치어빌리티-디스턴스**의 최소값을 의미한다. 즉 클러스터 $C$내에서 가장 가까이 붙어있는 두점사이의 거리를 의미한다. 식으로 쓰면 아래와 같다. 
\begin{align}
reach-dist-min=\min \\{ reach-dist(p,q): p,q \in C \\}
\end{align}
이와 유사하게 $reach-dist-max$ 도 정의할 수 있다. 이제 $\epsilon$을 아래와 같이 정의하자. 
\begin{align}
\epsilon=\frac{reach-dist-max}{reach-dist-min}-1
\end{align}
쉽게 생각해서 $C$안의 대부분의 점들의 엄청 모여있으면 $\epsilon \approx 0$ 와 같이 된다. 저자들은 (i) $p$의 $k$-근접이웃들이 모두 $C$의 원소이고(ii) $p$의 $k$-근접이웃들 각각의 $k$-근접이웃들까지 모두 $C$의 원소이면 
\begin{align}
\frac{1}{1+\epsilon}\leq LOF(p) \leq 1+\epsilon
\end{align}
이 성립한다고 주장한다. 

- 증명은 다음과 같다. 모든 $q \in N_k(p)$에 대하여 아래가 성립한다. 
\begin{align}
dist(p,q) \geq reach-dist-min
\end{align}
따라서 아래가 성립한다. 
\begin{align}
lrd_k(p) \leq \frac{1}{reach-dist-min}
\end{align}
이거랑 비슷한 논리로 아래가 성립한다. 
\begin{align}
lrd_k(p) \geq \frac{1}{reach-dist-max} 
\end{align}
위의 논쟁에서 $p$를 $q$로 바꾸고 $q$를 $o$로 바꾸면 아래역시 증명된다. 
\begin{align}
\frac{1}{reach-dist-max} \geq lrd_k(q) \leq \frac{1}{reach-dist-min}
\end{align}
따라서 원하는것이 증명된다. 

- 아무튼 Lemma 1을 잘 살펴보면 $\epsilon$이 클러스터의 tightness를 결정하고 (i)과 (ii)가 점 $p$가 얼마나 클러스터안에 **"포오옥~"** 파묻혀있는지를 메져한다. 잘 살펴보면 HST에서 $\tau \to \infty$일때 $\epsilon_{\tau} \to 0$으로 감을 증명하고, (즉 클러스터가 점점 tight해짐을 증명하고) $p$가 얼마나 클러스터에 파묻히는지 (혹은 파묻히지 않는지)를 보이면 의외로 증명이 쉬울 수 있다. 



### The impact of the parameter minpts 

